<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Tidy eval recipes for dplyr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>



<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%7D%0Apre%20%7B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Tidy eval recipes for dplyr</h1>


<div id="TOC">
<ul>
<li><a href="#patterns-for-single-arguments">Patterns for single arguments</a><ul>
<li><a href="#enquo-and---quote-and-unquote-arguments"><code>enquo()</code> and <code>!!</code> - Quote and unquote arguments</a></li>
<li><a href="#quo_name---create-default-column-names"><code>quo_name()</code> - Create default column names</a></li>
<li><a href="#and---unquote-column-names"><code>:=</code> and <code>!!</code> - Unquote column names</a></li>
</ul></li>
<li><a href="#patterns-for-multiple-arguments">Patterns for multiple arguments</a><ul>
<li><a href="#forward-multiple-arguments"><code>...</code> - Forward multiple arguments</a></li>
<li><a href="#enquos-and---quote-and-unquote-multiple-arguments"><code>enquos()</code> and <code>!!!</code> - Quote and unquote multiple arguments</a></li>
<li><a href="#expr---modify-quoted-arguments"><code>expr()</code> - Modify quoted arguments</a></li>
<li><a href="#vars---quote-multiple-arguments-externally"><code>vars()</code> - Quote multiple arguments externally</a></li>
<li><a href="#enquos.named-true---automatically-add-default-names"><code>enquos(.named = TRUE)</code> - Automatically add default names</a></li>
<li><a href="#quos_auto_name---manually-add-default-names"><code>quos_auto_name()</code> - Manually add default names</a></li>
</ul></li>
<li><a href="#select-recipes"><code>select()</code> recipes</a></li>
<li><a href="#filter-recipes"><code>filter()</code> recipes</a></li>
<li><a href="#gotchas">Gotchas</a><ul>
<li><a href="#nested-quoting-functions">Nested quoting functions</a></li>
</ul></li>
</ul>
</div>

<p>In the introductory vignette we learned that creating tidy eval functions boils down to a single pattern: quote and unquote. In this vignette we’ll apply this pattern in a series of recipes for dplyr.</p>
<p>This vignette is organised so that you can quickly find your way to a copy-paste solution when you face an immediate problem.</p>
<div id="patterns-for-single-arguments" class="section level2">
<h2>Patterns for single arguments</h2>
<div id="enquo-and---quote-and-unquote-arguments" class="section level3">
<h3><code>enquo()</code> and <code>!!</code> - Quote and unquote arguments</h3>
<p>We start with a quick recap of the introductory vignette. Creating a function around dplyr pipelines involves three steps: abstraction, quoting, and unquoting.</p>
<ul>
<li><p><strong>Abstraction step</strong></p>
<p>First identify the varying parts:</p>
<pre class="sourceCode r"><code class="sourceCode r">df1 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(x1) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y1))
df2 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(x2) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y2))
df3 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(x3) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y3))
df4 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(x4) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y4))</code></pre>
<p>And abstract those away with a informative argument names:</p>
<pre class="sourceCode r"><code class="sourceCode r">data %&gt;%<span class="st"> </span><span class="kw">group_by</span>(group_var) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(summary_var))</code></pre>
<p>And wrap in a function:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(data, group_var, summary_var) {
  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(summary_var))
}</code></pre></li>
<li><p><strong>Quoting step</strong></p>
<p>Identify all the arguments where the user is allowed to refer to data frame columns directly. The function can’t evaluate these arguments right away. Instead they should be automatically quoted. Apply <code>enquo()</code> to these arguments</p>
<pre class="sourceCode r"><code class="sourceCode r">group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(group_var)
summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)</code></pre></li>
<li><p><strong>Unquoting step</strong></p>
<p>Identify where these variables are passed to other quoting functions and unquote with <code>!!</code>. In this case we pass <code>group_var</code> to <code>group_by()</code> and <code>summary_var</code> to <code>summarise()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">data %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))</code></pre></li>
</ul>
<p>We end up with a function that automatically quotes its arguments <code>group_var</code> and <code>summary_var</code> and unquotes them when they are passed to other quoting functions:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(data, group_var, summary_var) {
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(group_var)
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean</span>(mtcars, cyl, mpg)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;     cyl  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4  26.7</span>
<span class="co">#&gt; 2     6  19.7</span>
<span class="co">#&gt; 3     8  15.1</span></code></pre>
</div>
<div id="quo_name---create-default-column-names" class="section level3">
<h3><code>quo_name()</code> - Create default column names</h3>
<p>Use <code>quo_name()</code> to transform a quoted expression to a column name:</p>
<pre class="sourceCode r"><code class="sourceCode r">simple_var &lt;-<span class="st"> </span><span class="kw">quote</span>(height)
<span class="kw">quo_name</span>(simple_var)
<span class="co">#&gt; [1] &quot;height&quot;</span></code></pre>
<p>These names are only a default stopgap. For more complex uses, you’ll probably want to let the user override the default. Here is a case where the default name is clearly suboptimal:</p>
<pre class="sourceCode r"><code class="sourceCode r">complex_var &lt;-<span class="st"> </span><span class="kw">quote</span>(<span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
<span class="kw">quo_name</span>(complex_var)
<span class="co">#&gt; [1] &quot;mean(height, na.rm = TRUE)&quot;</span></code></pre>
</div>
<div id="and---unquote-column-names" class="section level3">
<h3><code>:=</code> and <code>!!</code> - Unquote column names</h3>
<p>In expressions like <code>c(name = NA)</code>, the argument name is quoted. Because of the quoting it’s not possible to make an indirect reference to a variable that contains a name:</p>
<pre class="sourceCode r"><code class="sourceCode r">name &lt;-<span class="st"> &quot;the real name&quot;</span>
<span class="kw">c</span>(<span class="dt">name =</span> <span class="ot">NA</span>)
<span class="co">#&gt; name </span>
<span class="co">#&gt;   NA</span></code></pre>
<p>In tidy eval function it is possible to unquote argument names with <code>!!</code>. However you need the special <code>:=</code> operator:</p>
<pre class="sourceCode r"><code class="sourceCode r">rlang::<span class="kw">qq_show</span>(<span class="kw">c</span>(!!name :<span class="er">=</span><span class="st"> </span><span class="ot">NA</span>))
<span class="co">#&gt; c(&quot;the real name&quot; := NA)</span></code></pre>
<p>This unusual operator is needed because using <code>!</code> on the left-hand side of <code>=</code> is not valid R code:</p>
<pre class="sourceCode r"><code class="sourceCode r">rlang::<span class="kw">qq_show</span>(<span class="kw">c</span>(!!<span class="dt">name =</span> <span class="ot">NA</span>))
<span class="co">#&gt; Error: &lt;text&gt;:1:25: unexpected '='</span>
<span class="co">#&gt; 1: rlang::qq_show(c(!!name =</span>
<span class="co">#&gt;                             ^</span></code></pre>
<p>Let’s use this <code>!!</code> technique to pass custom column names to <code>group_by()</code> and <code>summarise()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(data, group_var, summary_var) {
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(group_var)
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)

  <span class="co"># Create default column names</span>
  group_nm &lt;-<span class="st"> </span><span class="kw">quo_name</span>(group_var)
  summary_nm &lt;-<span class="st"> </span><span class="kw">quo_name</span>(summary_var)

  <span class="co"># Prepend with an informative prefix</span>
  group_nm &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;group_&quot;</span>, group_nm)
  summary_nm &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;mean_&quot;</span>, summary_nm)

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_nm :<span class="er">=</span><span class="st"> </span>!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(!!summary_nm :<span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean</span>(mtcars, cyl, mpg)
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   group_cyl mean_mpg</span>
<span class="co">#&gt;       &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1         4     26.7</span>
<span class="co">#&gt; 2         6     19.7</span>
<span class="co">#&gt; 3         8     15.1</span></code></pre>
</div>
</div>
<div id="patterns-for-multiple-arguments" class="section level2">
<h2>Patterns for multiple arguments</h2>
<div id="forward-multiple-arguments" class="section level3">
<h3><code>...</code> - Forward multiple arguments</h3>
<p>We have created a function that takes one grouping variable and one summary variable. It would make sense to take multiple grouping variables instead of just one. Let’s adjust our function with a <code>...</code> argument.</p>
<ol style="list-style-type: decimal">
<li><p>Replace <code>group_var</code> by <code>...</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">function(data, ..., summary_var)</code></pre></li>
<li><p>Swap <code>...</code> and <code>summary_var</code> because arguments on the right-hand side of <code>...</code> are harder to pass. They can only be passed with their full name explictly specified while arguments on the left-hand side can be passed without name:</p>
<pre class="sourceCode r"><code class="sourceCode r">function(data, summary_var, ...)</code></pre></li>
<li><p>It’s good practice to prefix named arguments with a <code>.</code> to reduce the risk of conflicts between your arguments and the arguments passed to <code>...</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">function(.data, .summary_var, ...)</code></pre></li>
</ol>
<p>Because of the magic of dots forwarding we don’t have to use the quote-and-unquote pattern. We can just pass <code>...</code> to other quoting functions like <code>group_by()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(...) %&gt;%<span class="st">  </span><span class="co"># Forward `...`</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0 136. </span>
<span class="co">#&gt; 2     4     1  93.6</span>
<span class="co">#&gt; 3     6     0 205. </span>
<span class="co">#&gt; 4     6     1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span></code></pre>
<p>Forwarding <code>...</code> is straightforward but has the downside that you can’t modify the arguments or their names.</p>
</div>
<div id="enquos-and---quote-and-unquote-multiple-arguments" class="section level3">
<h3><code>enquos()</code> and <code>!!!</code> - Quote and unquote multiple arguments</h3>
<p>Quoting and unquoting multiple variables with <code>...</code> is pretty much the same process as for single arguments:</p>
<ul>
<li><p>Quoting multiple arguments can be done in two ways: internal quoting with the plural variant <code>enquos()</code> and external quoting with <code>vars()</code>. Use internal quoting when your function takes expressions with <code>...</code> and external quoting when your function takes a list of expressions.</p></li>
<li><p>Unquoting multiple arguments requires a variant of <code>!!</code>, the unquote-splice operator <code>!!!</code> which unquotes each element of a list as an independent argument in the surrounding function call.</p></li>
</ul>
<p>Quote the dots with <code>enquos()</code> and unquote-splice them with <code>!!!</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)  <span class="co"># Get a list of quoted dots</span>

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%<span class="st">  </span><span class="co"># Unquote-splice the list</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0 136. </span>
<span class="co">#&gt; 2     4     1  93.6</span>
<span class="co">#&gt; 3     6     0 205. </span>
<span class="co">#&gt; 4     6     1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span></code></pre>
<p>The quote-and-unquote pattern does more work than simple forwarding of <code>...</code> and is functionally identical. Don’t do this extra work unless you need to modify the arguments or their names.</p>
</div>
<div id="expr---modify-quoted-arguments" class="section level3">
<h3><code>expr()</code> - Modify quoted arguments</h3>
<p>Modifying quoted expressions is often necessary when dealing with multiple arguments. Say we’d like a <code>grouped_mean()</code> variant that takes multiple summary variables rather than multiple grouping variables. We need to somehow take the <code>mean()</code> of each summary variable.</p>
<p>One easy way is to use the quote-and-unquote pattern with <code>expr()</code>. This function is just like <code>quote()</code> from base R. It plainly returns your argument, quoted:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quote</span>(height)
<span class="co">#&gt; height</span>

<span class="kw">expr</span>(height)
<span class="co">#&gt; height</span>


<span class="kw">quote</span>(<span class="kw">mean</span>(height))
<span class="co">#&gt; mean(height)</span>

<span class="kw">expr</span>(<span class="kw">mean</span>(height))
<span class="co">#&gt; mean(height)</span></code></pre>
<p>But <code>expr()</code> has a twist, it has full unquoting support:</p>
<pre class="sourceCode r"><code class="sourceCode r">vars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">quote</span>(height), <span class="kw">quote</span>(mass))

<span class="kw">expr</span>(<span class="kw">mean</span>(!!vars[[<span class="dv">1</span>]]))
<span class="co">#&gt; mean(height)</span>

<span class="kw">expr</span>(<span class="kw">group_by</span>(!!!vars))
<span class="co">#&gt; group_by(height, mass)</span></code></pre>
<p>You can loop over a list of arguments and modify each of them:</p>
<pre class="sourceCode r"><code class="sourceCode r">purrr::<span class="kw">map</span>(vars, function(var) <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; mean(height, na.rm = TRUE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; mean(mass, na.rm = TRUE)</span></code></pre>
<p>This makes it easy to take multiple summary variables, wrap them in a call to <code>mean()</code>, before unquote-splicing within <code>summarise()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean3 &lt;-<span class="st"> </span>function(.data, .group_var, ...) {
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.group_var)
  summary_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)  <span class="co"># Get a list of quoted summary variables</span>

  summary_vars &lt;-<span class="st"> </span>purrr::<span class="kw">map</span>(summary_vars, function(var) {
    <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  })

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(!!!summary_vars)  <span class="co"># Unquote-splice the list</span>
}</code></pre>
</div>
<div id="vars---quote-multiple-arguments-externally" class="section level3">
<h3><code>vars()</code> - Quote multiple arguments externally</h3>
<p>How could we take multiple summary variables in addition to multiple grouping variables? Internal quoting with <code>...</code> has a major disadvantage: the arguments in <code>...</code> can only have one purpose. If you need to quote multiple sets of variables you have to delegate the quoting to another function. That’s the purpose of <code>vars()</code> which quotes its arguments and returns a list:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vars</span>(species, gender)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^species</span>
<span class="co">#&gt;   env:  global</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^gender</span>
<span class="co">#&gt;   env:  global</span></code></pre>
<p>The arguments can be complex expressions and have names:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vars</span>(<span class="dt">h =</span> height, <span class="dt">m =</span> mass /<span class="st"> </span><span class="dv">100</span>)
<span class="co">#&gt; $h</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^height</span>
<span class="co">#&gt;   env:  global</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $m</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^mass / 100</span>
<span class="co">#&gt;   env:  global</span></code></pre>
<p>When the quoting is external you don’t use <code>enquos()</code>. Simply take lists of expressions in your function and forward the lists to other quoting functions with <code>!!!</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean3 &lt;-<span class="st"> </span>function(data, group_vars, summary_vars) {
  <span class="kw">stopifnot</span>(
    <span class="kw">is.list</span>(group_vars),
    <span class="kw">is.list</span>(summary_vars)
  )

  summary_vars &lt;-<span class="st"> </span>purrr::<span class="kw">map</span>(summary_vars, function(var) {
    <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  })

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>(), !!!summary_vars)
}

<span class="kw">grouped_mean3</span>(starwars, <span class="kw">vars</span>(species, gender), <span class="kw">vars</span>(height))
<span class="co">#&gt; # A tibble: 43 x 4</span>
<span class="co">#&gt; # Groups:   species [?]</span>
<span class="co">#&gt;   species  gender     n `mean(height, na.rm = TRUE)`</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;  &lt;int&gt;                        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Aleena   male       1                           79</span>
<span class="co">#&gt; 2 Besalisk male       1                          198</span>
<span class="co">#&gt; 3 Cerean   male       1                          198</span>
<span class="co">#&gt; 4 Chagrian male       1                          196</span>
<span class="co">#&gt; # ... with 39 more rows</span>

<span class="kw">grouped_mean3</span>(starwars, <span class="kw">vars</span>(gender), <span class="kw">vars</span>(height, mass))
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   gender            n `mean(height, na.rm = TRUE… `mean(mass, na.rm = TRU…</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;int&gt;                       &lt;dbl&gt;                    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 female           19                        165.                     54.0</span>
<span class="co">#&gt; 2 hermaphrodite     1                        175                    1358  </span>
<span class="co">#&gt; 3 male             62                        179.                     81.0</span>
<span class="co">#&gt; 4 none              2                        200                     140  </span>
<span class="co">#&gt; # ... with 1 more row</span></code></pre>
<p>One advantage of <code>vars()</code> is that it lets users specify their own names:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean3</span>(starwars, <span class="kw">vars</span>(gender), <span class="kw">vars</span>(<span class="dt">h =</span> height, <span class="dt">m =</span> mass))
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   gender            n     h      m</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 female           19  165.   54.0</span>
<span class="co">#&gt; 2 hermaphrodite     1  175  1358  </span>
<span class="co">#&gt; 3 male             62  179.   81.0</span>
<span class="co">#&gt; 4 none              2  200   140  </span>
<span class="co">#&gt; # ... with 1 more row</span></code></pre>
</div>
<div id="enquos.named-true---automatically-add-default-names" class="section level3">
<h3><code>enquos(.named = TRUE)</code> - Automatically add default names</h3>
<p>If you pass <code>.named = TRUE</code> to <code>enquos()</code> the unnamed expressions are automatically given default names:</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function(...) <span class="kw">names</span>(<span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>))

<span class="kw">f</span>(height, <span class="kw">mean</span>(mass))
<span class="co">#&gt; [1] &quot;height&quot;     &quot;mean(mass)&quot;</span></code></pre>
<p>User-supplied names are never overridden:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">f</span>(height, <span class="dt">m =</span> <span class="kw">mean</span>(mass))
<span class="co">#&gt; [1] &quot;height&quot; &quot;m&quot;</span></code></pre>
<p>This is handy when you need to modify the names of quoted expressions. In this example we’ll ensure the list is named before adding a prefix:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>)  <span class="co"># Ensure quoted dots are named</span>

  <span class="co"># Prefix the names of the list of quoted dots</span>
  <span class="kw">names</span>(group_vars) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;group_&quot;</span>, <span class="kw">names</span>(group_vars))

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%<span class="st">  </span><span class="co"># Unquote-splice the list</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   group_cyl [?]</span>
<span class="co">#&gt;   group_cyl group_am  mean</span>
<span class="co">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1         4        0 136. </span>
<span class="co">#&gt; 2         4        1  93.6</span>
<span class="co">#&gt; 3         6        0 205. </span>
<span class="co">#&gt; 4         6        1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span></code></pre>
<p>One big downside of this technique is that all arguments get a prefix, including the arguments that were given specific names by the user:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean2</span>(mtcars, disp, <span class="dt">c =</span> cyl, <span class="dt">a =</span> am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   group_c [?]</span>
<span class="co">#&gt;   group_c group_a  mean</span>
<span class="co">#&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1       4       0 136. </span>
<span class="co">#&gt; 2       4       1  93.6</span>
<span class="co">#&gt; 3       6       0 205. </span>
<span class="co">#&gt; 4       6       1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span></code></pre>
<p>In general it’s better to preserve the names explicitly passed by the user. To do that we can’t automatically add default names with <code>enquos()</code> because once the list is fully named we don’t have any way of detecting which arguments were passed with an explicit names. We’ll have to add default names manually with <code>quos_auto_name()</code>.</p>
</div>
<div id="quos_auto_name---manually-add-default-names" class="section level3">
<h3><code>quos_auto_name()</code> - Manually add default names</h3>
<p>It can be helpful add default names to the list of quoted dots manually:</p>
<ul>
<li>We can detect which arguments were explicitly named by the user.</li>
<li>The default names can be applied to lists returned by <code>vars()</code>.</li>
</ul>
<p>Let’s add default names manually with <code>quos_auto_name()</code> to lists of externally quoted variables. We’ll detect unnamed arguments and only add a prefix to this subset of arguments. This way we preserve user-supplied names:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean3 &lt;-<span class="st"> </span>function(data, group_vars, summary_vars) {
  <span class="kw">stopifnot</span>(
    <span class="kw">is.list</span>(group_vars),
    <span class="kw">is.list</span>(summary_vars)
  )

  <span class="co"># Detect and prefix unnamed arguments:</span>
  unnamed &lt;-<span class="st"> </span><span class="kw">names</span>(summary_vars) ==<span class="st"> &quot;&quot;</span>

  <span class="co"># Add the default names:</span>
  summary_vars &lt;-<span class="st"> </span>rlang::<span class="kw">quos_auto_name</span>(summary_vars)

  prefixed_nms &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;mean_&quot;</span>, <span class="kw">names</span>(summary_vars)[unnamed])
  <span class="kw">names</span>(summary_vars)[unnamed] &lt;-<span class="st"> </span>prefixed_nms

  <span class="co"># Expand the argument _after_ giving the list its default names</span>
  summary_vars &lt;-<span class="st"> </span>purrr::<span class="kw">map</span>(summary_vars, function(var) {
    <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  })

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>(), !!!summary_vars)  <span class="co"># Unquote-splice the renamed list</span>
}</code></pre>
<p>Note how we add the default names <em>before</em> wrapping the arguments in a <code>mean()</code> call. This way we avoid including <code>mean()</code> in the name:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quo_name</span>(<span class="kw">quote</span>(mass))
<span class="co">#&gt; [1] &quot;mass&quot;</span>

<span class="kw">quo_name</span>(<span class="kw">quote</span>(<span class="kw">mean</span>(mass, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))
<span class="co">#&gt; [1] &quot;mean(mass, na.rm = TRUE)&quot;</span></code></pre>
<p>We get nicely prefixed default names:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean3</span>(starwars, <span class="kw">vars</span>(gender), <span class="kw">vars</span>(height, mass))
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   gender            n mean_height mean_mass</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;int&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 female           19        165.      54.0</span>
<span class="co">#&gt; 2 hermaphrodite     1        175     1358  </span>
<span class="co">#&gt; 3 male             62        179.      81.0</span>
<span class="co">#&gt; 4 none              2        200      140  </span>
<span class="co">#&gt; # ... with 1 more row</span></code></pre>
<p>And the user is able to fully override the names:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean3</span>(starwars, <span class="kw">vars</span>(gender), <span class="kw">vars</span>(<span class="dt">h =</span> height, <span class="dt">m =</span> mass))
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   gender            n     h      m</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 female           19  165.   54.0</span>
<span class="co">#&gt; 2 hermaphrodite     1  175  1358  </span>
<span class="co">#&gt; 3 male             62  179.   81.0</span>
<span class="co">#&gt; 4 none              2  200   140  </span>
<span class="co">#&gt; # ... with 1 more row</span></code></pre>
</div>
</div>
<div id="select-recipes" class="section level2">
<h2><code>select()</code> recipes</h2>
<p>TODO</p>
</div>
<div id="filter-recipes" class="section level2">
<h2><code>filter()</code> recipes</h2>
<p>TODO</p>
</div>
<div id="gotchas" class="section level2">
<h2>Gotchas</h2>
<div id="nested-quoting-functions" class="section level3">
<h3>Nested quoting functions</h3>
<p><a href="https://stackoverflow.com/questions/51902438/rlangsym-in-anonymous-functions" class="uri">https://stackoverflow.com/questions/51902438/rlangsym-in-anonymous-functions</a></p>
<p>This is overall a good answer but the issue is not the nested mutate. It’s the unquoting inside an anonymous function, as you have shown with the <code>!!i</code> example. Unquoting happens immediately and anonymous functions create a future scope, so there’s a timing problem.</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
