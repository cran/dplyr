<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Going further with tidyeval</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>



<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%7D%0Apre%20%7B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Going further with tidyeval</h1>


<div id="TOC">
<ul>
<li><a href="#quoting-and-unquoting-multiple-arguments">Quoting and unquoting multiple arguments</a><ul>
<li><a href="#writing-functions-taking-any-number-of-arguments">Writing functions taking any number of arguments</a></li>
<li><a href="#simple-forwarding-of-...">Simple forwarding of <code>...</code></a></li>
<li><a href="#quoting-multiple-arguments">Quoting multiple arguments</a></li>
<li><a href="#unquoting-multiple-arguments">Unquoting multiple arguments</a></li>
</ul></li>
<li><a href="#modifying-the-names-of-quoted-arguments">Modifying the names of quoted arguments</a><ul>
<li><a href="#default-argument-names">Default argument names</a></li>
<li><a href="#unquoting-argument-names">Unquoting argument names</a></li>
<li><a href="#prefixing-quoted-arguments">Prefixing quoted arguments</a></li>
</ul></li>
<li><a href="#modifying-quoted-arguments">Modifying quoted arguments</a><ul>
<li><a href="#expanding-quoted-expressions-with-expr">Expanding quoted expressions with <code>expr()</code></a></li>
</ul></li>
</ul>
</div>

<div id="quoting-and-unquoting-multiple-arguments" class="section level2">
<h2>Quoting and unquoting multiple arguments</h2>
<p>We have created a function that takes one grouping variable and one summary variable. It would make sense to take multiple grouping variables instead of just one. Quoting and unquoting multiple variables is pretty much the same process as for single arguments:</p>
<ul>
<li><p>Unquoting multiple arguments requires a variant of <code>!!</code>, the big bang operator <code>!!!</code>.</p></li>
<li><p>Quoting multiple arguments can be done in two ways: internal quoting with the plural variant <code>enquos()</code> and external quoting with <code>vars()</code>.</p></li>
</ul>
<div id="writing-functions-taking-any-number-of-arguments" class="section level3">
<h3>Writing functions taking any number of arguments</h3>
<p>The dot-dot-dot argument is one of the nicest aspect of the R language. A function that takes <code>...</code> accepts any number of arguments, named or unnamed. As a programmer you can do three things with <code>...</code>:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Evaluate</strong> the arguments contained in the dots and materialise them in a list by forwarding the dots to <code>list()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">materialise &lt;-<span class="st"> </span>function(data, ...) {
    dots &lt;-<span class="st"> </span><span class="kw">list</span>(...)
    dots
}</code></pre>
<p>The dots names conveniently become the names of the list:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">materialise</span>(mtcars, <span class="dv">1</span> +<span class="st"> </span><span class="dv">2</span>, <span class="dt">important_name =</span> letters)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 3</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $important_name</span>
<span class="co">#&gt;  [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot; &quot;g&quot; &quot;h&quot; &quot;i&quot; &quot;j&quot; &quot;k&quot; &quot;l&quot; &quot;m&quot; &quot;n&quot; &quot;o&quot; &quot;p&quot; &quot;q&quot;</span>
<span class="co">#&gt; [18] &quot;r&quot; &quot;s&quot; &quot;t&quot; &quot;u&quot; &quot;v&quot; &quot;w&quot; &quot;x&quot; &quot;y&quot; &quot;z&quot;</span></code></pre></li>
<li><p><strong>Quote</strong> the arguments in the dots with <code>enquos()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">capture &lt;-<span class="st"> </span>function(data, ...) {
    dots &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)
    dots
}</code></pre>
<p>All arguments passed to <code>...</code> are automatically quoted and returned as a list. The names of the arguments become the names of that list:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">capture</span>(mtcars, <span class="dv">1</span> +<span class="st"> </span><span class="dv">2</span>, <span class="dt">important_name =</span> letters)
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^1 + 2</span>
<span class="co">#&gt;   env:  global</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $important_name</span>
<span class="co">#&gt; &lt;quosure&gt;</span>
<span class="co">#&gt;   expr: ^letters</span>
<span class="co">#&gt;   env:  global</span></code></pre></li>
<li><p><strong>Forward</strong> the dots to another function:</p>
<pre class="sourceCode r"><code class="sourceCode r">forward &lt;-<span class="st"> </span>function(data, ...) {
  <span class="kw">forwardee</span>(...)
}</code></pre>
<p>When dots are forwarded the names of arguments in <code>...</code> are matched to the arguments of the forwardee:</p>
<pre class="sourceCode r"><code class="sourceCode r">forwardee &lt;-<span class="st"> </span>function(foo, bar, ...) {
  <span class="kw">list</span>(<span class="dt">foo =</span> foo, <span class="dt">bar =</span> bar, ...)
}</code></pre>
<p>Let’s call the forwarding function with a bunch of named and unnamed arguments:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">forward</span>(mtcars, <span class="dt">bar =</span> <span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)
<span class="co">#&gt; $foo</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $bar</span>
<span class="co">#&gt; [1] 100</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 3</span></code></pre>
<p>The unnamed argument <code>1</code> was matched to <code>foo</code> positionally. The named argument <code>bar</code> was matched to <code>bar</code>. The remaining arguments were passed in order.</p></li>
</ol>
<p>For the purpose of writing tidy eval functions the last two techniques are important. There are two distinct situations:</p>
<ol style="list-style-type: decimal">
<li><p>You don’t need to modify the arguments in any way, just passing them through. Then simply forward <code>...</code> to other quoting functions in the ordinary way.</p></li>
<li><p>You’d like to change the argument names (which become column names in <code>dplyr::mutate()</code> calls) or modify the arguments themselves (for instance negate a <code>dplyr::select()</code>ion). In that case you’ll need to use <code>enquos()</code> to <em>quote</em> the arguments in the dots. You’ll then pass the quoted arguments to other quoting functions by <em>forwarding</em> them with the help of <code>!!!</code>.</p></li>
</ol>
</div>
<div id="simple-forwarding-of-..." class="section level3">
<h3>Simple forwarding of <code>...</code></h3>
<p>If you are not modifying the arguments in <code>...</code> in any way and just want to pass them to another quoting function, just forward <code>...</code> like usual! There is no need for quoting and unquoting because of the magic of forwarding. The arguments in <code>...</code> are transported to their final destination where they will be quoted.</p>
<p>The function <code>grouped_mean()</code> is still going to need some remodelling because it is good practice to take all important named arguments before the dots. Let’s start by swapping <code>grouped_var</code> and <code>summary_var</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(data, summary_var, group_var) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(group_var)

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}</code></pre>
<p>Then we replace <code>group_var</code> with <code>...</code> and pass it to <code>group_by()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(data, summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(...) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}</code></pre>
<p>It is good practice to make one final adjustment. Because arguments in <code>...</code> can have arbitrary names, we don’t want to “use up” valid names. In tidyverse packages we use the convention of prefixing named arguments with a dot so that conflicts are less likely:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  .summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(...) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!.summary_var))
}</code></pre>
<p>Let’s check this function now works with any number of grouping variables:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0 136. </span>
<span class="co">#&gt; 2     4     1  93.6</span>
<span class="co">#&gt; 3     6     0 205. </span>
<span class="co">#&gt; 4     6     1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span>

<span class="kw">grouped_mean</span>(mtcars, disp, cyl, am, vs)
<span class="co">#&gt; # A tibble: 7 x 4</span>
<span class="co">#&gt; # Groups:   cyl, am [?]</span>
<span class="co">#&gt;     cyl    am    vs  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0     1 136. </span>
<span class="co">#&gt; 2     4     1     0 120. </span>
<span class="co">#&gt; 3     4     1     1  89.8</span>
<span class="co">#&gt; 4     6     0     1 205. </span>
<span class="co">#&gt; # ... with 3 more rows</span></code></pre>
</div>
<div id="quoting-multiple-arguments" class="section level3">
<h3>Quoting multiple arguments</h3>
<p>When we need to modify the arguments or their names, we can’t simply forward the dots. We’ll have to quote and unquote with the plural variants of <code>enquo()</code> and <code>!!</code>.</p>
<ul>
<li>We’ll quote the dots with <code>enquos()</code>.</li>
<li>We’ll unquote-splice the quoted dots with <code>!!!</code>.</li>
</ul>
<p>While the singular <code>enquo()</code> returns a single quoted argument, the plural variant <code>enquos()</code> returns a list of quoted arguments. Let’s use it to quote the dots:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(data, summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)

  data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_vars) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}</code></pre>
<p><code>grouped_mean()</code> now accepts and automatically quotes any number of grouping variables. However it doesn’t work quite yet:</p>
<p><strong>FIXME</strong>: Depend on dev rlang to get a better error message.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; Error in mutate_impl(.data, dots): Column `structure(list(~cyl, ~am), .Names = c(&quot;&quot;, &quot;&quot;), class = &quot;quosures&quot;)` must be length 32 (the number of rows) or one, not 2</span></code></pre>
<p>Instead of <em>forwarding</em> the individual arguments to <code>group_by()</code> we have passed the list of arguments itself! Unquoting is not the right operation here. Fortunately tidy eval provides a special operator that makes it easy to forward a list of arguments.</p>
</div>
<div id="unquoting-multiple-arguments" class="section level3">
<h3>Unquoting multiple arguments</h3>
<p>The <strong>unquote-splice</strong> operator <code>!!!</code> takes each element of a list and unquotes them as independent arguments to the surrounding function call. The arguments are <em>spliced</em> in the function call. This is just what we need for forwarding multiple quoted arguments.</p>
<p>Let’s use <code>qq_show()</code> to observe the difference between <code>!!</code> and <code>!!!</code> in a <code>group_by()</code> expression. We can only use <code>enquos()</code> within a function so let’s create a list of quoted names for the purpose of experimenting:</p>
<pre class="sourceCode r"><code class="sourceCode r">vars &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="kw">quote</span>(cyl),
  <span class="kw">quote</span>(am)
)</code></pre>
<p><code>qq_show()</code> shows the difference between unquoting a list and unquote-splicing a list:</p>
<pre class="sourceCode r"><code class="sourceCode r">rlang::<span class="kw">qq_show</span>(<span class="kw">group_by</span>(!!vars))
<span class="co">#&gt; group_by(&lt;list: cyl, am&gt;)</span>

rlang::<span class="kw">qq_show</span>(<span class="kw">group_by</span>(!!!vars))
<span class="co">#&gt; group_by(cyl, am)</span></code></pre>
<p>When we use the unquote operator <code>!!</code>, <code>group_by()</code> gets a list of expressions. When we unquote-splice with <code>!!!</code>, the expressions are forwarded as individual arguments to <code>group_by()</code>. Let’s use the latter to can fix <code>grouped_mean2()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(!!summary_var))
}</code></pre>
<p>The quote and unquote version of <code>grouped_mean()</code> does a bit more work but is functionally identical to the forwarding version:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0 136. </span>
<span class="co">#&gt; 2     4     1  93.6</span>
<span class="co">#&gt; 3     6     0 205. </span>
<span class="co">#&gt; 4     6     1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span>

<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0 136. </span>
<span class="co">#&gt; 2     4     1  93.6</span>
<span class="co">#&gt; 3     6     0 205. </span>
<span class="co">#&gt; 4     6     1 155  </span>
<span class="co">#&gt; # ... with 2 more rows</span></code></pre>
<p>When does it become useful to do all this extra work? Whenever you need to modify the arguments or their names.</p>
<p>Up to now we have used the quote-and-unquote pattern to pass quoted arguments to other quoting functions “as is”. With this simple and powerful pattern you can extract complex combinations of quoting verbs into reusable functions.</p>
<p>However tidy eval provides much more flexibility. It is a general purpose meta-programming framework that makes it easy to modify quoted arguments before evaluation. In this section you’ll learn about basic metaprogramming patterns.</p>
</div>
</div>
<div id="modifying-the-names-of-quoted-arguments" class="section level2">
<h2>Modifying the names of quoted arguments</h2>
<p>Functions like <code>grouped_mean()</code> create new columns in the data frame. It might be helpful to automatically create names that reflect the meaning of those columns. In this section you’ll learn how to create default names for quoted arguments and how to unquote names.</p>
<div id="default-argument-names" class="section level3">
<h3>Default argument names</h3>
<p>If you are familiar with dplyr you have probably noticed that new columns are given default names when you don’t supply one explictly to <code>mutate()</code> or <code>summarise()</code>. These default names are not practical for further manipulation but they are helpful to remind rushed users what their new column is about:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">average =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; # A tibble: 1 x 1</span>
<span class="co">#&gt;   average</span>
<span class="co">#&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1    174.</span>

starwars %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; # A tibble: 1 x 1</span>
<span class="co">#&gt;   `mean(height, na.rm = TRUE)`</span>
<span class="co">#&gt;                          &lt;dbl&gt;</span>
<span class="co">#&gt; 1                         174.</span></code></pre>
<p>You can create default names by applying <code>quo_name()</code> to any expressions:</p>
<pre class="sourceCode r"><code class="sourceCode r">var1 &lt;-<span class="st"> </span><span class="kw">quote</span>(height)
var2 &lt;-<span class="st"> </span><span class="kw">quote</span>(<span class="kw">mean</span>(height))

<span class="kw">quo_name</span>(var1)
<span class="co">#&gt; [1] &quot;height&quot;</span>
<span class="kw">quo_name</span>(var2)
<span class="co">#&gt; [1] &quot;mean(height)&quot;</span></code></pre>
<p>Including automatically quoted arguments:</p>
<pre class="sourceCode r"><code class="sourceCode r">arg_name &lt;-<span class="st"> </span>function(var) {
  var &lt;-<span class="st"> </span><span class="kw">enquo</span>(var)

  <span class="kw">quo_name</span>(var)
}

<span class="kw">arg_name</span>(height)
<span class="co">#&gt; [1] &quot;height&quot;</span>

<span class="kw">arg_name</span>(<span class="kw">mean</span>(height))
<span class="co">#&gt; [1] &quot;mean(height)&quot;</span></code></pre>
<p>Lists of quoted expressions require a different approach because we don’t want to override user-supplied names. The easiest way is call <code>enquos()</code> with <code>.named = TRUE</code>. When this option, all unnamed arguments get a default name:</p>
<pre class="sourceCode r"><code class="sourceCode r">args_names &lt;-<span class="st"> </span>function(...) {
  vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>)
  <span class="kw">names</span>(vars)
}

<span class="kw">args_names</span>(<span class="kw">mean</span>(height), weight)
<span class="co">#&gt; [1] &quot;mean(height)&quot; &quot;weight&quot;</span>

<span class="kw">args_names</span>(<span class="dt">avg =</span> <span class="kw">mean</span>(height), weight)
<span class="co">#&gt; [1] &quot;avg&quot;    &quot;weight&quot;</span></code></pre>
</div>
<div id="unquoting-argument-names" class="section level3">
<h3>Unquoting argument names</h3>
<p>Argument names are one of the most common occurrence of quotation in R. There is no fundamental difference between these two ways of creating a <code>&quot;myname&quot;</code> string:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(<span class="kw">c</span>(<span class="dt">Mickey =</span> <span class="ot">NA</span>))
<span class="co">#&gt; [1] &quot;Mickey&quot;</span>

<span class="kw">quo_name</span>(<span class="kw">quote</span>(Mickey))
<span class="co">#&gt; [1] &quot;Mickey&quot;</span></code></pre>
<p>Where there is quotation it is natural to have unquotation. For this reason, tidy eval makes it possible to use <code>!!</code> to unquote names. Unfortunately we’ll have to use a somewhat peculiar syntax to unquote names because using complex expressions on the left-hand side of <code>=</code> is not valid R code:</p>
<pre class="sourceCode r"><code class="sourceCode r">nm &lt;-<span class="st"> &quot;Mickey&quot;</span>
<span class="kw">args_names</span>(!!<span class="dt">nm =</span> <span class="dv">1</span>)
<span class="co">#&gt; Error: &lt;text&gt;:2:17: unexpected '='</span>
<span class="co">#&gt; 1: nm &lt;- &quot;Mickey&quot;</span>
<span class="co">#&gt; 2: args_names(!!nm =</span>
<span class="co">#&gt;                    ^</span></code></pre>
<p>Instead you’ll have to unquote of the LHS of <code>:=</code>. This vestigial operator is interpreted by tidy eval functions in exactly the same way as <code>=</code> but with <code>!!</code> support:</p>
<pre class="sourceCode r"><code class="sourceCode r">nm &lt;-<span class="st"> &quot;Mickey&quot;</span>
<span class="kw">args_names</span>(!!nm :<span class="er">=</span><span class="st"> </span><span class="dv">1</span>)
<span class="co">#&gt; [1] &quot;Mickey&quot;</span></code></pre>
<p>Another way of achieving the same result is to splice a named list of arguments:</p>
<pre class="sourceCode r"><code class="sourceCode r">args &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">list</span>(<span class="dv">1</span>), nm)
<span class="kw">args_names</span>(!!!args)
<span class="co">#&gt; [1] &quot;Mickey&quot;</span></code></pre>
<p>This works because <code>!!!</code> uses the names of the list as argument names. This is a great pattern when you are dealing with multiple arguments:</p>
<pre class="sourceCode r"><code class="sourceCode r">nms &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Mickey&quot;</span>, <span class="st">&quot;Minnie&quot;</span>)
args &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">list</span>(<span class="dv">1</span>, <span class="dv">2</span>), nms)
<span class="kw">args_names</span>(!!!args)
<span class="co">#&gt; [1] &quot;Mickey&quot; &quot;Minnie&quot;</span></code></pre>
</div>
<div id="prefixing-quoted-arguments" class="section level3">
<h3>Prefixing quoted arguments</h3>
<p>Now that we know how to unquote argument, let’s apply informative prefixes to the names of the columns created in <code>grouped_mean()</code>. We’ll start with the summary variable:</p>
<ol style="list-style-type: decimal">
<li>Get the default name of the quoted summary variable.</li>
<li>Prepend it with a prefix.</li>
<li>Unquote it with <code>!!</code> and <code>:=</code>.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)

  <span class="co"># Get and modify the default name</span>
  summary_nm &lt;-<span class="st"> </span><span class="kw">quo_name</span>(summary_var)
  summary_nm &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;avg_&quot;</span>, summary_nm)

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(!!summary_nm :<span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(!!summary_var))  <span class="co"># Unquote the name</span>
}

<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   cyl [?]</span>
<span class="co">#&gt;     cyl    am avg_disp</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4     0    136. </span>
<span class="co">#&gt; 2     4     1     93.6</span>
<span class="co">#&gt; 3     6     0    205. </span>
<span class="co">#&gt; 4     6     1    155  </span>
<span class="co">#&gt; # ... with 2 more rows</span>

<span class="kw">names</span>(<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am))
<span class="co">#&gt; [1] &quot;cyl&quot;      &quot;am&quot;       &quot;avg_disp&quot;</span></code></pre>
<p>Regarding the grouping variables, this is a case where explictly quoting and unquoting <code>...</code> pays off because we need to change the names of the list of quoted dots:</p>
<ul>
<li>Give default names to quoted dots with <code>.named = TRUE</code>.</li>
<li>Prepend the names of the list with a prefix.</li>
<li>Unquote-splice the list of quoted arguments as usual.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean2 &lt;-<span class="st"> </span>function(.data, .summary_var, ...) {
  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.summary_var)

  <span class="co"># Quote the dots with default names</span>
  group_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>)

  summary_nm &lt;-<span class="st"> </span><span class="kw">quo_name</span>(summary_var)
  summary_nm &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;avg_&quot;</span>, summary_nm)

  <span class="co"># Modify the names of the list of quoted dots</span>
  <span class="kw">names</span>(group_vars) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;groups_&quot;</span>, <span class="kw">names</span>(group_vars))

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!!group_vars) %&gt;%<span class="st">  </span><span class="co"># Unquote-splice as usual</span>
<span class="st">    </span><span class="kw">summarise</span>(!!summary_nm :<span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(!!summary_var))
}

<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am)
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt; # Groups:   groups_cyl [?]</span>
<span class="co">#&gt;   groups_cyl groups_am avg_disp</span>
<span class="co">#&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1          4         0    136. </span>
<span class="co">#&gt; 2          4         1     93.6</span>
<span class="co">#&gt; 3          6         0    205. </span>
<span class="co">#&gt; 4          6         1    155  </span>
<span class="co">#&gt; # ... with 2 more rows</span>

<span class="kw">names</span>(<span class="kw">grouped_mean2</span>(mtcars, disp, cyl, am))
<span class="co">#&gt; [1] &quot;groups_cyl&quot; &quot;groups_am&quot;  &quot;avg_disp&quot;</span></code></pre>
</div>
</div>
<div id="modifying-quoted-arguments" class="section level2">
<h2>Modifying quoted arguments</h2>
<p>The quote-and-unquote pattern is a powerful and versatile technique. In this section we’ll use it for modifying quoted arguments.</p>
<p>Say we would like a version of <code>grouped_mean()</code> where we take multiple summary variables rather than multiple grouping variables. We could start by replacing <code>summary_var</code> with the <code>...</code> argument:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean3 &lt;-<span class="st"> </span>function(.data, .group_var, ...) {
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.group_var)
  summary_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>)

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(!!!summary_vars)  <span class="co"># How do we take the mean?</span>
}</code></pre>
<p>The quoting part is easy. But how do we go about taking the average of each argument before passing them on to <code>summarise()</code>? We’ll have to modify the list of summary variables.</p>
<div id="expanding-quoted-expressions-with-expr" class="section level3">
<h3>Expanding quoted expressions with <code>expr()</code></h3>
<p>Quoting and unquoting is an effective technique for modifying quoted expressions. But we’ll need to add one more function to our toolbox to work around the lack of unquoting support in <code>quote()</code>.</p>
<p>As we saw, the fundamental quoting function in R is <code>quote()</code>. All it does is return its quoted argument:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quote</span>(<span class="kw">mean</span>(mass))
<span class="co">#&gt; mean(mass)</span></code></pre>
<p><code>quote()</code> does not support quasiquotation but tidy eval provides a variant that does. With <code>expr()</code>, you can quote expressions with full unquoting support:</p>
<pre class="sourceCode r"><code class="sourceCode r">vars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">quote</span>(mass), <span class="kw">quote</span>(height))

<span class="kw">expr</span>(<span class="kw">mean</span>(!!vars[[<span class="dv">1</span>]]))
<span class="co">#&gt; mean(mass)</span>

<span class="kw">expr</span>(<span class="kw">group_by</span>(!!!vars))
<span class="co">#&gt; group_by(mass, height)</span></code></pre>
<p>Note what just happened: by quoting-and-unquoting, we have expanded existing quoted expressions! This is the key to modifying expressions before passing them on to other quoting functions. For instance we could loop over the summary variables and unquote each of them in a <code>mean()</code> expression:</p>
<pre class="sourceCode r"><code class="sourceCode r">purrr::<span class="kw">map</span>(vars, function(var) <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; mean(mass, na.rm = TRUE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; mean(height, na.rm = TRUE)</span></code></pre>
<p>Let’s fix <code>grouped_mean3()</code> using this pattern:</p>
<pre class="sourceCode r"><code class="sourceCode r">grouped_mean3 &lt;-<span class="st"> </span>function(.data, .group_var, ...) {
  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(.group_var)
  summary_vars &lt;-<span class="st"> </span><span class="kw">enquos</span>(..., <span class="dt">.named =</span> <span class="ot">TRUE</span>)

  <span class="co"># Wrap the summary variables with mean()</span>
  summary_vars &lt;-<span class="st"> </span>purrr::<span class="kw">map</span>(summary_vars, function(var) {
    <span class="kw">expr</span>(<span class="kw">mean</span>(!!var, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
  })

  <span class="co"># Prefix the names with `avg_`</span>
  <span class="kw">names</span>(summary_vars) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;avg_&quot;</span>, <span class="kw">names</span>(summary_vars))

  .data %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(!!group_var) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(!!!summary_vars)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grouped_mean3</span>(starwars, species, height)
<span class="co">#&gt; # A tibble: 38 x 2</span>
<span class="co">#&gt;   species  avg_height</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Aleena           79</span>
<span class="co">#&gt; 2 Besalisk        198</span>
<span class="co">#&gt; 3 Cerean          198</span>
<span class="co">#&gt; 4 Chagrian        196</span>
<span class="co">#&gt; # ... with 34 more rows</span>

<span class="kw">grouped_mean3</span>(starwars, species, height, mass)
<span class="co">#&gt; # A tibble: 38 x 3</span>
<span class="co">#&gt;   species  avg_height avg_mass</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Aleena           79       15</span>
<span class="co">#&gt; 2 Besalisk        198      102</span>
<span class="co">#&gt; 3 Cerean          198       82</span>
<span class="co">#&gt; 4 Chagrian        196      NaN</span>
<span class="co">#&gt; # ... with 34 more rows</span></code></pre>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
